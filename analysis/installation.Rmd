---
title: "Installation and Motivating Example"
author: "borangao"
date: "2022-11-09"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Installation of MESuSiE

```{r,message=FALSE,warning=FALSE}
library(devtools)
# Install MESuSiE
install_github("borangao/MESuSiE",dependencies = FALSE)
# Load MESuSiE
library(MESuSiE)
```

# Motivating Example

The motivating example is based on a toy dataset outlined in the manuscript.

## 1. Data Characteristics

The dataset contains:

- Six SNPs categorized into three distinct LD clusters.
- Within each cluster, the SNPs show strong correlations.
- Between clusters, SNP correlations are weak.

### Causal SNPs: 

The primary advantage of MESuSiE lies in its capacity to differentiate between shared and ancestry-specific causal signals. For demonstration purposes, we simulated a dataset containing one shared and two ancestry-specific causal signals.

- **SNP 4**: Simulated as a shared causal SNP across ancestries.
- **SNP 2**: Simulated as the causal SNP specific to the BB ancestry.
- **SNP 6**: Simulated as the causal SNP specific to the WB ancestry.

### SNP Grouping

1. **Cluster 1**: Contains SNP 1 and 2.
2. **Cluster 2**: Contains SNP 3 and 4.
3. **Cluster 3**: Contains SNP 5 and 6.

## 2. Input of MESuSiE
The package comes with the necessary data included. To use MESuSiE, two lists are required: one for summary statistics and another for LD matrices, each from multiple ancestries. It's essential to name each element in these lists, ensuring that the naming is consistent between the summary statistics and LD matrices.
```{r,message=FALSE,warning=FALSE}
data(summ_stat_list)
data(LD_list)
summ_stat_list
```
Each element in the summary statistics list represents a data frame of GWAS summary statistics for each ancestry. This data frame should have columns named SNP, Beta, Se, Z, and N, which correspond to the SNP information, marginal effect size, standard error, Z-scores, and sample size, respectively.
```{r,message=FALSE,warning=FALSE}
LD_list
```
Each element in the LD matrices list corresponds to an LD matrix for a specific ancestry. The column names of this matrix should match the SNP names found in the summary statistics, ensuring consistency across data.

>**Note:** For a detailed tutorial, please refer to [Data Preparation](https://borangao.github.io/meSuSie_Analysis/GWAS_QC.html) and [analysis](https://borangao.github.io/meSuSie_Analysis/Run_MESuSiE.html).

## 3. Analysis 

### MESuSiE
```{r,message=FALSE,warning=FALSE}
MESuSiE_res<-meSuSie_core(LD_list,summ_stat_list,L=10)
MESuSiE_res$pip_config
```
We observed that three SNPs have a posterior inclusion probability (PIP) exceeding the 0.5 threshold. Upon further examination of the PIP for ancestry-specificity and shared traits, we identified that SNP4 is shared, while SNP2 and SNP6 are ancestry-specific. The categories within the credible set indicate the ancestries affected by the SNPs present in the set.

### SuSiE
```{r,message=FALSE,warning=FALSE}
library(susieR)
susie_WB<-susie_rss(summ_stat_list$WB$Z,LD_list$WB)
susie_BB<-susie_rss(summ_stat_list$BB$Z,LD_list$BB)
susie_WB$pip
susie_BB$pip
```
For the univariate SuSiE analysis, we found that SNP 3 and 6 are signals distinct to Europeans. In contrast, SNP 2 and 4 are signals unique to Africans, based on a PIP threshold of 0.5.

### Paintor
```{r,message=FALSE,warning=FALSE}
##We load the Paintor result directly
paintor_res<-read.table("/net/fantasia/home/borang/Susie_Mult/Revision_Round_1/Simulation/091223/data/toy_example/result/fig1.mcmc.paintor",header=T)
paintor_res$Posterior_Prob
```

Paintor identifies SNP2-6 as signals without distinguishing ancestry-specific or shared causal variant.


## 4. Visualization
```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=9,fig.height=6}
library(ggplot2)
library(dplyr)
###########################################################################
#
#
#             Result Plot Part
#
#
##########################################################################

custom_theme <- function() {
  theme(
    axis.text.x = element_text(size = 5),
    axis.text.y = element_text(size = 5),  
    axis.title.x = element_text(size = 7, face="bold"),
    axis.title.y = element_text(size = 7, face="bold"),
    strip.text.x = element_text(size = 5),
    strip.text.y = element_text(size = 5),
    strip.background = element_blank(),
    legend.text = element_text(size=7),
    legend.title = element_text(size=7, face="bold"),
    plot.title = element_text(size=7, hjust = 0.5),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(), 
    axis.line = element_line(color = "black")
  )
}
#############################################################
#
#
#
#				Beta Plot
#
#
#
###############################################################
beta_WB_all<-c(0,0,0,0.02,0,0.02)
beta_BB_all<-c(0,0.02,0,0.02,0,0)
WB_bar_data <- data.frame(SNP=paste0("SNP",seq(1,6,1)),Effect = beta_WB_all,Signal =c("None","BB","None","Shared","None","WB"))
BB_bar_data <- data.frame(SNP=paste0("SNP",seq(1,6,1)),Effect = beta_BB_all,Signal =c("None","BB","None","Shared","None","WB"))
# Grouped
bar_WB<-ggplot(WB_bar_data, aes( y=Effect, x=SNP,fill = Signal)) + xlab("")+ylab("Effect")+
  geom_bar(position="dodge", stat="identity")+theme_bw()+scale_fill_manual("Signal",values=c("WB"="#F2C1B6","BB"="#ABDB9F","Shared" = "#6162B0","None"="gray"))+theme(legend.position="none")
bar_WB = bar_WB + custom_theme()
bar_BB<-ggplot(BB_bar_data, aes( y=Effect, x=SNP,fill = Signal)) + xlab("")+ylab("Effect")+
  geom_bar(position="dodge", stat="identity")+theme_bw()+scale_fill_manual("Signal",values=c("WB"="#F2C1B6","BB"="#ABDB9F","Shared" = "#6162B0","None"="gray"))+theme(legend.position="none")
bar_BB = bar_BB + custom_theme()
#############################################################
#
#
#
#				GWAS Plot
#
#
#
###############################################################
z_WB<-summ_stat_list$WB$Z
z_BB<-summ_stat_list$BB$Z
gwas_data<-data.frame("SNP"=paste0("SNP",seq(1,6,1)),"WB_Pvalue"= -log10(2*pnorm(-abs(z_WB))),"BB_Pvalue"=-log10(2*pnorm(-abs(z_BB))))
locuszoom_WB<-ggplot(gwas_data,aes(x=SNP,y=WB_Pvalue))+theme_bw()+geom_point(size =2)+
                       geom_hline(yintercept=8, linetype="dashed", color = "red")+
                       labs(x="",y="-log10 P-value") +custom_theme()
locuszoom_BB<-ggplot(gwas_data,aes(x=SNP,y=BB_Pvalue))+theme_bw()+geom_point(size =2)+
  geom_hline(yintercept=8, linetype="dashed", color = "red")+
  labs(x="",y="-log10 P-value") +custom_theme()

#############################################################
#
#
#
#					LD plot
#
#
#
###############################################################
WB_cov<-LD_list$WB
BB_cov<-LD_list$BB
melt_WB_cov<-matrix(ncol=3,nrow=0)
melt_WB_cov<-data.frame(melt_WB_cov)
melt_BB_cov<-matrix(ncol=3,nrow=0)
melt_BB_cov<-data.frame(melt_BB_cov)
for(SNP1 in 1:6){
  for(SNP2 in SNP1:6){
    melt_WB_cov<-rbind(melt_WB_cov,c(paste0("SNP",SNP1),paste0("SNP",SNP2),WB_cov[SNP1,SNP2]))
    melt_BB_cov<-rbind(melt_BB_cov,c(paste0("SNP",SNP1),paste0("SNP",SNP2),BB_cov[SNP1,SNP2]))
  }
}
colnames(melt_WB_cov)<-c("SNP1","SNP2","Value")
melt_WB_cov$Value<-(as.numeric(melt_WB_cov$Value))
colnames(melt_BB_cov)<-c("SNP1","SNP2","Value")
melt_BB_cov$Value<-(as.numeric(melt_BB_cov$Value))

WB_cor<-ggplot(melt_WB_cov, aes(x = SNP1, y = SNP2, fill = Value)) +
  geom_tile(aes( fill = abs(Value)))+scale_fill_stepsn(
    colors = c( "#F7F172","#F7CD72","#F7A972","#F78E72", "#F77772"),
    breaks = seq(0, 0.8, by = 0.2),
    limits = c(0, 1),
    show.limits = TRUE,
    na.value = 'grey50',
    name = "",guide = FALSE
  )+
  geom_text(aes(label=round(Value,2)),size = 5/14*5,fontface="bold")+
  theme_bw() +xlab("White British")+ylab("Correlation") +custom_theme()

BB_cor<-ggplot(melt_BB_cov, aes(x = SNP1, y = SNP2, fill = Value)) +
  geom_tile(aes( fill = abs(Value)))+scale_fill_stepsn(
    colors =  c( "#F7F172","#F7CD72","#F7A972","#F78E72", "#F77772"),
    breaks = seq(0, 0.8, by = 0.2),
    limits = c(0, 1),
    show.limits = TRUE,
    na.value = 'grey50',
    name = "",guide = FALSE
  )+
  geom_text(aes(label=round(Value,2)), size = 5/14*5, fontface="bold")+
  theme_bw() +xlab("Black British")+ylab("Correlation") +custom_theme()


#############################################################
#
#
#
#				Fine mapping plot
#
#
#
###############################################################
#############################################################
#					MESuSie 
#############################################################

MESuSiE_pip<-data.frame(MESuSiE_res$pip_config)
colnames(MESuSiE_pip)<-c("WB","BB","Shared")

Signal_vec <- MESuSiE_pip %>%
  mutate(Signal_vec = case_when(
    Shared > 0.5 ~ "Shared",
    WB > 0.5 ~ "White British",
    BB > 0.5 ~ "Black British",
    TRUE ~ "None"
  ))%>%pull(Signal_vec)

MESuSiE_plot_data<-data.frame(SNP=paste0("SNP",seq(1,6,1)),PIP=MESuSiE_res$pip,Signal =Signal_vec )
MESuSiE_plot_data$Signal<-factor(MESuSiE_plot_data$Signal,levels = c("White British","Black British","Shared","Either","None"))

MESuSiE_plot<-ggplot(MESuSiE_plot_data,aes(x=SNP,y=PIP,fill=Signal,shape = Signal))+theme_bw()+geom_point(size =3)+
  scale_fill_manual("Signal",values=c("White British"="#F2C1B6","Black British"="#ABDB9F","Shared" = "#6162B0","Either" = "#DB6C79","None"="gray"),drop = FALSE)+
  scale_shape_manual("Signal",values=c("White British"=24,"Black British" = 25,"Shared" = 23,"Either" = 22,"None"=20),drop = FALSE)+
  scale_y_continuous(limits=c(0, 1.1)) +geom_hline(yintercept=0.5, linetype="dashed")+
  labs(x="MESuSiE",y="PIP")                                                                                                                                                                                                                                                                           
MESuSiE_plot<-MESuSiE_plot+custom_theme()

#############################################################
#					SuSie WB
#############################################################
library(ggplot2)
library(cowplot)

SuSiE_pip<-data.frame(WB = susie_WB$pip, BB = susie_BB$pip)
colnames(SuSiE_pip)<-c("WB","BB")

Signal_vec <- SuSiE_pip %>%
  mutate(Signal_vec = case_when(
    WB > 0.5 & BB < 0.5 ~ "White British",
    BB > 0.5 & WB > 0.5~ "Shared",
    TRUE ~ "None"
  ))%>%pull(Signal_vec)

SuSiE_WB_data<-data.frame(SNP=paste0("SNP",seq(1,6,1)),PIP= susie_WB$pip,Signal =Signal_vec )
SuSiE_WB_data$Signal<-factor(SuSiE_WB_data$Signal,levels =  c("White British","Black British","Shared","Either","None"))

SuSiE_WB_plot<-ggplot(SuSiE_WB_data,aes(x=SNP,y=PIP,fill=Signal,shape = Signal))+theme_bw()+geom_point(size =3)+
  scale_fill_manual("Signal",values=c("White British"="#F2C1B6","Black British"="#ABDB9F","Shared" = "#6162B0","Either" = "#DB6C79","None"="gray"),drop = FALSE)+
  scale_shape_manual("Signal",values=c("White British"=24,"Black British" = 25,"Shared" = 23,"Either" = 22,"None"=20),drop = FALSE)+
  scale_y_continuous(limits=c(0, 1.1)) +geom_hline(yintercept=0.5, linetype="dashed")+
  labs(x="SuSiE White British",y="PIP")                                                                                                                                                                                                                                                                           
SuSiE_WB_plot<-SuSiE_WB_plot+custom_theme()
#############################################################
#					SuSie BB
###############################################################
Signal_vec <- SuSiE_pip %>%
  mutate(Signal_vec = case_when(
    WB < 0.5 & BB > 0.5 ~ "Black British",
    BB > 0.5 & WB > 0.5~ "Shared",
    TRUE ~ "None"
  ))%>%pull(Signal_vec)
SuSiE_BB_data<-data.frame(SNP=paste0("SNP",seq(1,6,1)),PIP= susie_BB$pip,Signal =Signal_vec )
SuSiE_BB_data$Signal<-factor(SuSiE_BB_data$Signal,levels = c("White British","Black British","Shared","Either","None"))

SuSiE_BB_plot<-ggplot(SuSiE_BB_data,aes(x=SNP,y=PIP,fill=Signal,shape = Signal))+theme_bw()+geom_point(size =3)+
  scale_fill_manual("Signal",values=c("White British"="#F2C1B6","Black British"="#ABDB9F","Shared" = "#6162B0","Either" = "#DB6C79","None"="gray"),drop = FALSE)+
  scale_shape_manual("Signal",values=c("White British"=24,"Black British" = 25,"Shared" = 23,"Either" = 22,"None"=20),drop = FALSE)+
    scale_y_continuous(limits=c(0, 1.1)) +geom_hline(yintercept=0.5, linetype="dashed")+
  labs(x="SuSiE Black British",y="PIP")                                                                                                                                                                                                                                                                           
SuSiE_BB_plot<-SuSiE_BB_plot+custom_theme()
#############################################################
#				Paintor
#############################################################

Paintor_pip<-data.frame( paintor_res$Posterior_Prob)
colnames(Paintor_pip)<-c("Either")

Signal_vec <- Paintor_pip %>%
  mutate(Signal_vec = case_when(
    Either > 0.5 ~ "Either",
    TRUE ~ "None"
  ))%>%pull(Signal_vec)

Paintor_plot_data<-data.frame(SNP=paste0("SNP",seq(1,6,1)),PIP=Paintor_pip$Either,Signal =Signal_vec )
Paintor_plot_data$Signal<-factor(Paintor_plot_data$Signal,levels =  c("White British","Black British","Shared","Either","None"))

Paintor_plot<-ggplot(Paintor_plot_data,aes(x=SNP,y=PIP,fill=Signal,shape = Signal))+theme_bw()+geom_point(size =3)+
  scale_fill_manual("Signal",values=c("White British"="#F2C1B6","Black British"="#ABDB9F","Shared" = "#6162B0","Either" = "#DB6C79","None"="gray"),drop = FALSE)+
  scale_shape_manual("Signal",values=c("White British"=24,"Black British" = 25,"Shared" = 23,"Either" = 22,"None"=20),drop = FALSE)+
  scale_y_continuous(limits=c(0, 1.1)) +geom_hline(yintercept=0.5, linetype="dashed")+
  labs(x="Paintor",y="PIP")                                                                                                                                                                                                                                                                           
Paintor_plot<-Paintor_plot+custom_theme()

library(ggpubr)
beta_gwas_test<-ggarrange(bar_WB,bar_BB,ncol=2,nrow=1)
locuszoom_test<-ggarrange(locuszoom_WB,locuszoom_BB,ncol=2,nrow=1)
LD_test<-ggarrange(WB_cor,BB_cor,ncol=2,nrow=1)
labeled_plot<-ggarrange(beta_gwas_test, locuszoom_test, LD_test,labels = c("a", "b", "c") ,font.label=list(color="black",size=7), nrow=3, ncol=1)
pip_plot<-ggarrange(SuSiE_WB_plot,SuSiE_BB_plot,MESuSiE_plot,Paintor_plot,ncol=2,nrow = 2 ,common.legend = TRUE, legend="bottom")
pip_plot<-ggarrange(pip_plot, labels = c("d"),font.label=list(color="black",size=7))
Fig_1<-ggarrange(labeled_plot,pip_plot,ncol=2,widths=c(4.5,5.5))
Fig_1
```

